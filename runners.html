---
layout: page
title: Runners
permalink: /runners/
---

<div id="searchfield">
  <h3>Search for a runner :</h3>
  <form>
    <input type="text" name="runner" class="biginput" id="autocomplete" autocomplete="on"
    value="Type the name of a runner here..."
    onblur="if (this.value==''){this.value='Type the name of a runner here...';}" 
    onfocus="if (this.value!=''){this.value='';}">
  </form>
</div>

<div id="map"></div>
<div id="outputbox">
  <p id="outputcontent">Choose a runner and the results will be displayed here.</p>
</div>


<script type="text/javascript">
	var myMap = null;
	var runners = [
		{value:"Bosshart Catherine 1948",data:"bosshartcatherine1948"},
		{value:"Veillard Steeve 1982",data:"veillardsteeve1982"},
		{value:"Chanon Theo 2005",data:"chanontheo2005"},
		{value:"Schmidt Peter 1952",data:"schmidtpeter1952"}
	];
	var currentRunner = null;
</script>

<script type="text/javascript">
	// TODO: 	- complete list of runners -> transfer folder manually, 
	//			  do NOT change the _config.yml

/* Draw a map of Switzerland with pointers where a runner has done a 
race, if coordinates are known. Only in the situation in which "All 
races" is selected. */
function drawFullMap() {
	if (myMap) {
		myMap.remove();
		myMap = null;
	}
	if (currentRunner) {
		$('#map').empty()
		$('#map').height(340).width(600)
		myMap = L.map('map').setView([46.8182,8.2275], 7);
		// Add actual layer
		var Stamen_Terrain_full = L.tileLayer('http://stamen-tiles-{s}.a.ssl.fastly.net/terrain/{z}/{x}/{y}.{ext}', {
			attribution: 'Map tiles by <a href="http://stamen.com">Stamen Design</a>, <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a> &mdash; Map data &copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',
			subdomains: 'abcd',
			minZoom: 0,
			maxZoom: 18,
			ext: 'png'
		}).addTo(myMap);
		for (let key of Object.keys(currentRunner.races)) {
			var currentRace = currentRunner.races[key]
			var mLat = currentRace.latitude;
			var mLong = currentRace.longitude;
			var nbParticipation = Object.keys(currentRace.date).length;
			if (mLat!=null && mLong!=null) {
				marker = L.marker([mLat, mLong]).addTo(myMap);
				var popupMarker = "<b href='#' onclick='clickPopupFullMap(this)' " 
					+ "onmouseover='mouseOverPopupFullMap(this)' "
					+ "onmouseout='mouseOutPopupFullMap(this)'>" + key 
					+ "</b><br>"+ nbParticipation +" participation";
				if (nbParticipation > 1) 
					popupMarker += "s.";
				else
					popupMarker += ".";
				marker.bindPopup(popupMarker)
			}
		}
	}
}

/* Functions called when an event is launched on a popup of the fullMap */
function clickPopupFullMap(elem) {
	key = elem.innerHTML
	$('#race').val(key);
	raceChanged();
}
function mouseOverPopupFullMap(elem) {
	elem.style.textDecoration = 'underline';
	elem.style.cursor = 'pointer';
}
function mouseOutPopupFullMap(elem) {
	elem.style.textDecoration = 'none';
}

/* Draw a map centered on the race location if coordinates are known */
function drawMap() {
	if (myMap)
		myMap.remove();
	if (currentRunner) {
		var selectedRace = $("#race").val();
		if (selectedRace != 'all') {
			var specificRace = currentRunner.races[selectedRace];
			// Get latitude and longitude
			var latitude = specificRace.latitude
			var longitude = specificRace.longitude
			if (latitude!=null && longitude!=null) {
				$('#map').empty()
				$('#map').height(400).width(500)
				myMap = L.map('map').setView([latitude,longitude], 14);
				// Add actual layer
				var Stamen_Terrain = L.tileLayer('http://stamen-tiles-{s}.a.ssl.fastly.net/terrain/{z}/{x}/{y}.{ext}', {
					attribution: 'Map tiles by <a href="http://stamen.com">Stamen Design</a>, <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a> &mdash; Map data &copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',
					subdomains: 'abcd',
					minZoom: 0,
					maxZoom: 18,
					ext: 'png'
				}).addTo(myMap);
			} else {
				$('#map').empty()
				$('#map').width(0).height(0)
				$('#globaldesc .text').width('100%')
			} 
		} else {
			$('#map').height(0).width(0);
			myMap = null;
		}
	}
}

/* Callback function for race selection */
function raceChanged() {
	console.log('raceChanged() entered')
	console.log(currentRunner)
	// Get selected racekey
	var selectedRace = $("#race").val();

	// Update dates select
	if (currentRunner) {
		if ($("#date")){
			$('#date').remove(); 
		}
		if (selectedRace == 'all') {
			drawFullMap()
				
		} else {
			drawMap()
			// Create select menu for dates
			var dateSelect = "<select id='date' onchange='dateChanged();'></select>"
			$('#outputbox').append(dateSelect)
			fillDateSelect(currentRunner.races[selectedRace].date)
		}
	}
}
</script>

<script type="text/javascript">
/* Callback function for date selection */
function dateChanged() {
	//drawMap()
}

/* Populate the race select menu with the available races for current runner
 *
 * Params :
 *  - races : dictionary with string races as keys
 * Returns :
 *  - sortedRaces : array of dictionaries (see below in for loop)
 */ 
function fillRaceSelect(races) {
  var sortedRaces = []
  for (r in races) {
    sortedRaces.push(
        {
          'racekey': r,
        })
  }
  //sortedRaces = sortedRaces.sort((a, b) => b.year - a.year)
  $('#race').empty()
  allRaces = "<option value='all'>All races</option>"
  $('#race').append(allRaces)
  sortedRaces.forEach(function(r) {
    option = '<option value="'+ r.racekey +'">'+r.racekey+'</option>'
    $('#race').append(option)
  })
  drawFullMap()
  return sortedRaces
}

/* Populate the date select menu with the available dates for current race, current runner
 *
 * Params :
 *  - dates : dictionary with string dates as keys and attributes 'day',
 *      'month', 'year'
 * Returns :
 *  - sortedDates : array of dictionaries (see below in for loop)
 */ 
function fillDateSelect(dates) {
	$('#date').empty()
	if (dates != 'all') {
		var sortedDates = []
		for (var d in dates) {
			sortedDates.push({
				'datekey': d,
				'day': dates[d].day,
				'month': dates[d].month,
				'year': dates[d].year
			})
		}
		sortedDates = sortedDates.sort((a, b) => b.year - a.year)
		allYears = "<option value='all'>All years</option>"
		$('#date').append(allYears)
		sortedDates.forEach(function(d) {
			option = "<option value='"+ d.datekey +"'>"+
			d.day + '/' + d.month + '/'+ d.year +"</option>"
		$('#date').append(option)
		})
		return sortedDates
	}
}

/* Callback function for race selection through search bar */
$(function(){
	$('#autocomplete').autocomplete({ 
		delay: 0,
		lookup: runners,

		onSelect: function (suggestion) {
			// Load JSON data
			$.getJSON("../runnerdata/" + suggestion.data + ".json", function(data) {
				console.log(data)
        
				// Set 'global' var to selected race
				currentRunner = data
  
				// Empty HTML
				$('#outputbox').empty()
				
				// Create select menu for races
				var raceSelect = "<select id='race' onchange='raceChanged();'></select>"
				$('#outputbox').append(raceSelect)
				var sortedRaces = fillRaceSelect(data.races)
				
				var selectedRace = $("#race").val();
				//var selectedDate = $("#date").val();
				$('#globaldesc').empty()
				$('#outputbox').append("<div id='globaldesc'></div>")
				$('#globaldesc').append("<div class='text'></div>")
				$('#globaldesc').append("<div id='map'></div>")
				
			})
		}
	});
}); 
</script>
