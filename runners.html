---
layout: page
title: Runners
permalink: /runners/
---

<div id="searchfield">
  <h3>Search for a runner :</h3>
  <form>
    <input type="text" name="runner" class="biginput" id="autocomplete" autocomplete="on"
    value="Type the name of a runner here..."
    onblur="if (this.value==''){this.value='Type the name of a runner here...';}" 
    onfocus="if (this.value!=''){this.value='';}">
  </form>
</div>

<div id="outputbox">
  <p id="outputcontent">Choose a runner and the results will be displayed here.</p>
</div>


<script type="text/javascript">
	var myMap = null;
	var runners = [
		{value:"Bosshart Catherine 1948",data:"bosshartcatherine1948"},
		{value:"Veillard Steeve 1982",data:"veillardsteeve1982"},
		{value:"Chanon Theo 2005",data:"chanontheo2005"},
		{value:"Schmidt Peter 1952",data:"schmidtpeter1952"},
		{value:"M\u00fcller Gu\u00e9nael 1998", data:"mullerguenael1998"}
	];
	var currentRunner = null;
</script>

<script type="text/javascript">
	// TODO: 	- complete list of runners -> transfer folder manually, 
	//			  do NOT change the _config.yml


// --------------- MAPS ------------------ //
/* Draw a map of Switzerland with pointers where a runner has done a 
race, if coordinates are known. Only in the situation in which "All 
races" is selected. */
function drawFullMap() {
	if (myMap) {
		myMap.remove();
		myMap = null;
	}
	if (currentRunner) {
		$('#map').empty()
		$('#map').height(340).width(600)
		myMap = L.map('map').setView([46.4804,8.1336], 7);
		// Add actual layer
		var Stamen_Terrain_full = L.tileLayer('http://stamen-tiles-{s}.a.ssl.fastly.net/terrain/{z}/{x}/{y}.{ext}', {
			attribution: 'Map tiles by <a href="http://stamen.com">Stamen Design</a>, <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a> &mdash; Map data &copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',
			subdomains: 'abcd',
			minZoom: 0,
			maxZoom: 18,
			ext: 'png'
		}).addTo(myMap);
		addMarkers()
	}
}

function addMarkers() {
	for (let key of Object.keys(currentRunner.races)) {
		var currentRace = currentRunner.races[key]
		var mLat = currentRace.latitude;
		var mLong = currentRace.longitude;
		var nbParticipation = Object.keys(currentRace.date).length;
		if (mLat!=null && mLong!=null) {
			marker = L.marker([mLat, mLong]).addTo(myMap);
			var popupMarker = "<b href='#' onclick='clickPopupFullMap(this)' " 
				+ "onmouseover='mouseOverPopupFullMap(this)' "
				+ "onmouseout='mouseOutPopupFullMap(this)'>" + key 
				+ "</b><br>"+ nbParticipation +" participation";
			if (nbParticipation > 1) 
				popupMarker += "s.";
			else
				popupMarker += ".";
			marker.bindPopup(popupMarker)
		}
	}
}

/* Functions called when an event is launched on a popup of the fullMap */
function clickPopupFullMap(elem) {
	key = elem.innerHTML
	$('#race').val(key);
	raceChanged();
}
function mouseOverPopupFullMap(elem) {
	elem.style.textDecoration = 'underline';
	elem.style.cursor = 'pointer';
}
function mouseOutPopupFullMap(elem) {
	elem.style.textDecoration = 'none';
}

/* Draw a map centered on the race location if coordinates are known */
function drawMap() {
	if (myMap)
		myMap.remove();
	if (currentRunner) {
		var selectedRace = $("#race").val();
		if (!selectedRace || selectedRace == ' ') {
			selectedRace = Object.keys(currentRunner.races)[0];
		}
		
		if (selectedRace != 'all') {
			var specificRace = currentRunner.races[selectedRace];
			// Get latitude and longitude
			var latitude = specificRace.latitude
			var longitude = specificRace.longitude
			if (latitude!=null && longitude!=null) {
				$('#map').empty()
				$('#map').height(400).width(500)
				myMap = L.map('map').setView([latitude,longitude], 14);
				// Add actual layer
				var Stamen_Terrain = L.tileLayer('http://stamen-tiles-{s}.a.ssl.fastly.net/terrain/{z}/{x}/{y}.{ext}', {
					attribution: 'Map tiles by <a href="http://stamen.com">Stamen Design</a>, <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a> &mdash; Map data &copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',
					subdomains: 'abcd',
					minZoom: 0,
					maxZoom: 18,
					ext: 'png'
				}).addTo(myMap);
				addMarkers();
			} else {
				$('#map').empty()
				$('#map').width(0).height(0)
				//$('#globaldesc .text').width('100%')
			} 
		} else {
			$('#map').height(0).width(0);
			myMap = null;
		}
	}
}

// --------------- RACE AND DATE SELECTION -------------------- //
/* Callback function for race selection */
function raceChanged() {
	console.log(currentRunner)
	// Get selected racekey
	var selectedRace = $("#race").val();
	if (!selectedRace || selectedRace == ' ') {
		selectedRace = Object.keys(currentRunner.races)[0];
	}

	// Update dates select
	if (currentRunner) {
		if ($("#date")){
			$('#date').remove(); 
		}
		if (selectedRace == 'all') {
			drawFullMap()
		} else {
			drawMap()
			
			if (Object.keys(currentRunner.races[selectedRace].date).length > 1) {
				// Create select menu for dates
				var dateSelect = "<select id='date' onchange='dateChanged();'></select>"
				$('#outputbox').append(dateSelect)
				fillDateSelect(currentRunner.races[selectedRace].date)
			}
		}
		var selectedPerf = $("#perf").val();
		drawPerformance(selectedPerf);
	}
}
</script>

<script type="text/javascript">
/* Callback function for date selection */
function dateChanged() {
	var selectedPerf = $("#perf").val();
	drawPerformance(selectedPerf);
}

function perfChanged() {
	var selectedPerf = $("#perf").val();
	drawPerformance(selectedPerf);
}

/* Populate the race select menu with the available races for current runner
 *
 * Params :
 *  - races : dictionary with string races as keys
 * Returns :
 *  - sortedRaces : array of dictionaries (see below in for loop)
 */ 
function fillRaceSelect(races) {
	var sortedRaces = []
	for (r in races) {
		sortedRaces.push({
			'racekey': r,
		})
	}

	$('#race').empty()
	allRaces = "<option value='all'>All races</option>"
	$('#race').append(allRaces)
	sortedRaces.forEach(function(r) {
		option = '<option value="'+ r.racekey +'">'+r.racekey+'</option>'
		$('#race').append(option)
	})
	drawFullMap()
	return sortedRaces
}

/* Populate the date select menu with the available dates for current race, current runner
 *
 * Params :
 *  - dates : dictionary with string dates as keys and attributes 'day',
 *      'month', 'year'
 * Returns :
 *  - sortedDates : array of dictionaries (see below in for loop)
 */ 
function fillDateSelect(dates) {
	$('#date').empty()
	if (dates != 'all') {
		var sortedDates = []
		for (var d in dates) {
			sortedDates.push({
				'datekey': d,
				'day': dates[d].day,
				'month': dates[d].month,
				'year': dates[d].year
			})
		}
		//if (sortedDates.length > 1) {
			sortedDates = sortedDates.sort((a, b) => b.year - a.year);
			allYears = "<option value='all'>All years</option>";
			$('#date').append(allYears);
			sortedDates.forEach(function(d) {
				option = "<option value='"+ d.datekey +"'>"+
				d.day + '/' + d.month + '/'+ d.year +"</option>";
			$('#date').append(option);
			})
		//} else {} ---------> TODO
		return sortedDates;
	}
}

function fillPerformanceSelect() {
	$('#perf').append("<option value='speed'> Speed </option>")
	$('#perf').append("<option value='pace'> Pace </option>")
	$('#perf').append("<option value='rank'> Ranking </option>")
	$('#perf').append("<option value='distance'> Distance </option>")
	drawPerformance('speed');
}

// ----------------- PERFORMANCE GRAPHS ---------------------- //
function getRunnerInfos() {
	var speed = [];
	var pace = [];
	var rank = []; // TODO: to normalize!
	var distance = [];
	var date = [];
	var selectedRace = $('#race').val();
	if (selectedRace = " ") {
		selectedRace = 'all';
	}

	if (selectedRace == 'all') {
		for (var keyRace in currentRunner.races) {
			for (var keyDate in currentRunner.races[keyRace].date) {
				for (var keyCat in currentRunner.races[keyRace].date[keyDate].categories) {
					var interest = currentRunner.races[keyRace].date[keyDate].categories[keyCat];
					speed.push(interest.time)
					pace.push(interest.pace)
					rank.push(interest.rank)
					distance.push(interest.distance)
					date.push(keyDate)
				}
			}
		}
	} else {
		var selectedDate = $('#date').val();
		if (selectedDate == 'all') {
			for (var keyDate in currentRunner.races[selectedRace].date) {
				for (var keyCat in currentRunner.races[selectedRace].date[keyDate].categories) {
					var interest = currentRunner.races[selectedRace].date[keyDate].categories[keyCat];
					speed.push(interest.time)
					pace.push(interest.pace)
					rank.push(interest.rank)
					distance.push(interest.distance)
					date.push(keyDate)
				}
			}
		} else {
			for (var keyCat in currentRunner.races[selectedRace].date[selectedDate].categories) {
					var interest = currentRunner.races[selectedRace].date[selectedDate].categories[keyCat];
					speed.push(interest.time)
					pace.push(interest.pace)
					rank.push(interest.rank)
					distance.push(interest.distance)
					date.push(keyDate)
				}
		}
	}
	return [distance, pace, rank, speed, date];
}

function getTotalNumberOfRunners(keyRace) {
	
}

function drawPerformance(keyPerf) {
	var infos = getRunnerInfos();
	
	if (infos[0].length > 1) {
		
		var perfId = 0;
		var units = "";
		switch (keyPerf) {
			case 'distance':
				perfId = 0;
				units = 'km';
				break;
			case 'pace':
				perfId = 1;
				units = 's/km';
				break;
			case 'rank':
				perfId = 2;
				break;
			default: //'speed'
				perfId = 3;
				units = 'km/h';
				break;
		}
		//var date = ['date'].concat(infos[4]);
		var chart = c3.generate({
			bindto: '#performance .chart',
			data: {
				columns: [
					[keyPerf].concat(infos[perfId])
				]
			}
		});
		
		var sumPerf = infos[perfId].reduce(function(a, b) { return a + b; });
		var avgPerf = sumPerf / infos[perfId].length;
		var maxPerf = infos[perfId].reduce(function(a, b) {
			if (a>b) return a;
			else return b;
		});
		var minPerf = infos[perfId].reduce(function(a, b) {
			if (a>b) return b;
			else return a;
		});
		
		var meanPerfStr = "<p>Mean " + keyPerf + ": " + avgPerf + " " + units + "</p>";
		var maxPerfStr = "<p>Maximal " + keyPerf + ": " + maxPerf + " " + units + "</p>";
		var minPerfStr = "<p>Minimal " + keyPerf + ": " + minPerf + " " + units + "</p>";
		var description = "<div class='text'>" + meanPerfStr + maxPerfStr + minPerfStr + "</div>";
		$(description).replaceAll('#performance .text')

	} else {

		$("<div class='chart'></div>").replaceAll('#performance .chart');
		var perfSpeed = "<p>Speed: " + infos[3][0] + " km/h </p>";
		var perfPace = "<p>Pace: " + infos[1][0] + " s/km </p>";
		var perfRank = "<p>Rank: " + infos[2][0] + "</p>";
		var perfDistance = "<p>Distance: " + infos[0][0] + " km </p>";
		var description = "<div class='text'>" + perfSpeed + perfPace + perfRank + perfDistance + "</div>";
		$(description).replaceAll('#performance .text')

	}
}

function drawSingleRunPerformance() {
	
}

function selectOnlyThis(elem,id) {
	for (var i = 1;i <= 4; i++)
    {
        document.getElementById("perfCheck" + i).checked = false;
    }
    elem.checked = true;
}

// -------------------- MAIN CALLBACK FUNCTION --------------------- //
/* Callback function for race selection through search bar */
$(function(){
	$('#autocomplete').autocomplete({ 
		delay: 0,
		lookup: runners,

		onSelect: function (suggestion) {
			// Load JSON data
			$.getJSON("../runnerdata/" + suggestion.data + ".json", function(data) {
				console.log(data)
        
				// Set 'global' var to selected race
				currentRunner = data
  
				// Empty HTML
				$('#outputbox').empty()
				
				// Title + personal information
				var today = new Date();
				var year = today.getFullYear();
				var sex = 'homme';
				if (currentRunner.sex == 'F')
					sex = 'femme';
				var title = "<h2>"+ currentRunner.name +" <small>"
					+ (year - currentRunner.birth) +" ans, "+ sex 
					+".</small></h2>";
				$('#outputbox').append(title);
									
				$('#outputbox').append("<div id='globaldesc'></div>")
				$('#globaldesc').append("<div id='map'></div>")
				
				// Create select menu for races, if > 1
				if (Object.keys(data.races).length > 1) {
					
					$('#globaldesc').append("<div class='text'></div>")
					var raceNoSelect = 
						"<p>This runner has participated to " + Object.keys(data.races).length
						+ " competitions. Click on them on the map or choose them below for more details.</p>";
					$('#globaldesc .text').append(raceNoSelect);
					
					// Race select menu
					var raceSelect = "<select id='race' onchange='raceChanged();'></select>"
					$('#outputbox').append(raceSelect)
					fillRaceSelect(data.races)
					
					// Display performance + perf select menu
					$('#outputbox').append("<div id='performance'></div>")
					var performanceSelect = "<div class='select'><select id='perf' onchange='perfChanged();'></select></div>"
					$('#performance').append(performanceSelect)
					$('#performance').append("<div class='chart'></div>")
					$('#performance').append("<div class='text'></div>")
					fillPerformanceSelect();

				} else {
					
					$('#globaldesc').append("<div class='text'></div>")
					var raceNoSelect = 
						"<p>This runner has participated to only one competition: " 
						+ Object.keys(data.races)[0] + "</p>";
					$('#globaldesc .text').append(raceNoSelect);
					drawFullMap();	

					// Create select menu for dates, if > 1
					var selectedRace = Object.keys(data.races)[0];
					
					if (Object.keys(data.races[selectedRace].date).length > 1) {
						
						var dateSelect = "<select id='date' onchange='dateChanged();'></select>"
						$('#outputbox').append(dateSelect)
						fillDateSelect(currentRunner.races[selectedRace].date)
						
						$('#outputbox').append("<div id='performance'></div>")
						var performanceSelect = "<div class='select'><select id='perf' onchange='perfChanged();'></select></div>"
						$('#performance').append(performanceSelect)
						$('#performance').append("<div class='chart'></div>")
						$('#performance').append("<div class='text'></div>")
						fillPerformanceSelect();
						
					} else {

						var mDate = currentRunner.races[selectedRace].date;
						var dateId = Object.keys(mDate)[0];
						var raceNoSelect = 
							"<p>This runner has participated to only one competition: " 
							+ Object.keys(data.races)[0] + ". <br>Run date: " 
							+ mDate[dateId].day + '/' + mDate[dateId].month + '/' 
							+ mDate[dateId].year + "</p>";
						$(raceNoSelect).replaceAll('#globaldesc .text');
						
						$('#outputbox').append("<div id='performance'></div>")
						$('#performance').append("<div class='chart'></div>")
						$('#performance').append("<div class='text'></div>")
						drawPerformance('speed')

					}
				
				}
				
			})
		}
	});
}); 
</script>
