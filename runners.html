---
layout: page
title: Runners
permalink: /runners/
---

<div id="searchfield">
  <h3>Search for a runner... <a id="randomlink" onmouseover="this.style.cursor = 'pointer'" onclick="displayRandom();">or
feel lucky !</a></h3>
  <form>
    <input type="text" name="runner" class="biginput" id="autocomplete" autocomplete="on"
    value="Type the name of a runner here..."
    onblur="if (this.value==''){this.value='Type the name of a runner here...';}" 
    onfocus="if (this.value!=''){this.value='';}">
  </form>
</div>

<div id="outputbox">
  <p id="outputcontent">Choose a runner and the results will be displayed here.</p>
</div>

<script type="text/javascript">
	var myMap = null;
	var runners = [
		{value:"Bosshart Catherine 1948",data:"bosshartcatherine1948"},
		{value:"Veillard Steeve 1982",data:"veillardsteeve1982"},
		{value:"Chanon Theo 2005",data:"chanontheo2005"},
		{value:"Schmidt Peter 1952",data:"schmidtpeter1952"},
		{value:"M\u00fcller Gu\u00e9nael 1998", data:"mullerguenael1998"}
	];
	var currentRunner = null;
	var allRacesObject = {};
</script>

<script type="text/javascript">
	// TODO: 	- complete list of runners -> transfer folder manually, 
	//			  do NOT change the _config.yml

function displayRandom() {
	var entry = Math.floor(Math.random() * runners.length);
	loadAndDisplay(runners[entry].data)
}

function encodeName(name) {
	function toLower(str) {
		return str.toLowerCase();
	}
	return name.replace(/[^0-9a-zA-Z+]/g, '').replace(/[A-Z]/g, toLower);
}

// --------------- MAPS ------------------ //
/* Draw a map of Switzerland with pointers where a runner has done a 
race, if coordinates are known. Only in the situation in which "All 
races" is selected. */
function drawFullMap() {
	if (myMap) {
		myMap.remove();
		myMap = null;
	}
	if (currentRunner) {
		$('#map').empty()
		$('#map').height(340).width(600)
		myMap = L.map('map').setView([46.4804,8.1336], 7);
		// Add actual layer
		var Stamen_Terrain_full = L.tileLayer('http://stamen-tiles-{s}.a.ssl.fastly.net/terrain/{z}/{x}/{y}.{ext}', {
			attribution: 'Map tiles by <a href="http://stamen.com">Stamen Design</a>, <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a> &mdash; Map data &copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',
			subdomains: 'abcd',
			minZoom: 0,
			maxZoom: 18,
			ext: 'png'
		}).addTo(myMap);
		addMarkers()
	}
}

function addMarkers() {
	for (let key of Object.keys(currentRunner.races)) {
		var currentRace = currentRunner.races[key]
		var mLat = currentRace.latitude;
		var mLong = currentRace.longitude;
		var nbParticipation = Object.keys(currentRace.date).length;
		if (mLat!=null && mLong!=null) {
			marker = L.marker([mLat, mLong]).addTo(myMap);
			var popupMarker = "<b href='#' onclick='clickPopupFullMap(this)' " 
				+ "onmouseover='mouseOverPopupFullMap(this)' "
				+ "onmouseout='mouseOutPopupFullMap(this)'>" + key 
				+ "</b><br>"+ nbParticipation +" participation";
			if (nbParticipation > 1) 
				popupMarker += "s.";
			else
				popupMarker += ".";
			var mLink = 'https://hopsuisse.github.io/races?date='+encodeName(key);
			popupMarker += "<br><a href=" + mLink + ">Race general details</a>";
			marker.bindPopup(popupMarker)
		}
	}
}

/* Functions called when an event is launched on a popup of the fullMap */
function clickPopupFullMap(elem) {
	key = elem.innerHTML
	$('#race').val(key);
	raceChanged();
}
function mouseOverPopupFullMap(elem) {
	elem.style.textDecoration = 'underline';
	elem.style.cursor = 'pointer';
}
function mouseOutPopupFullMap(elem) {
	elem.style.textDecoration = 'none';
}

/* Draw a map centered on the race location if coordinates are known */
function drawMap() {
	if (myMap)
		myMap.remove();
	if (currentRunner) {
		var selectedRace = $("#race").val();
		if (!selectedRace || selectedRace == ' ') {
			selectedRace = Object.keys(currentRunner.races)[0];
		}
		
		if (selectedRace != 'all') {
			var specificRace = currentRunner.races[selectedRace];
			// Get latitude and longitude
			var latitude = specificRace.latitude
			var longitude = specificRace.longitude
			if (latitude!=null && longitude!=null) {
				$('#map').empty()
				$('#map').height(400).width(500)
				myMap = L.map('map').setView([latitude,longitude], 14);
				// Add actual layer
				var Stamen_Terrain = L.tileLayer('http://stamen-tiles-{s}.a.ssl.fastly.net/terrain/{z}/{x}/{y}.{ext}', {
					attribution: 'Map tiles by <a href="http://stamen.com">Stamen Design</a>, <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a> &mdash; Map data &copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',
					subdomains: 'abcd',
					minZoom: 0,
					maxZoom: 18,
					ext: 'png'
				}).addTo(myMap);
				addMarkers();
			} else {
				$('#map').empty()
				$('#map').width(0).height(0)
				//$('#globaldesc .text').width('100%')
			} 
		} else {
			$('#map').height(0).width(0);
			myMap = null;
		}
	}
}

// --------------- RACE AND DATE SELECTION -------------------- //
/* Callback function for race selection */
function raceChanged() {
	console.log(currentRunner)
	// Get selected racekey
	var selectedRace = $("#race").val();
	if (!selectedRace || selectedRace == ' ') {
		selectedRace = Object.keys(currentRunner.races)[0];
	}

	// Update dates select
	if (currentRunner) {
		if ($("#chooseDate")){
			$("#date").remove();
			$('#chooseDate').remove(); 
		}
		if ($("#statRace")){
			$("#statRace").remove();
		}
		if (selectedRace == 'all') {
			drawFullMap()
		} else {
			drawMap()
			var dates = currentRunner.races[selectedRace].date;
			var mLink = 'https://hopsuisse.github.io/races?date='+encodeName(selectedRace);
			var statRace = 
				"<p id='statRace'>For more general statistics about this race, click <a href=" 
				+ mLink + ">here</a>.</p>"
			$('#selects .text').append(statRace);
			
			if (Object.keys(dates).length > 1) {
				// Create select menu for dates
				var chooseDate = "<p id='chooseDate'>Or choose a particular date, if desired: "
					+ "<select id='date' onchange='dateChanged();'></select></p>"
				$('#selects').append(chooseDate)
				fillDateSelect(dates)
			} else {
				var dateId = Object.keys(dates)[0];
				var date = "<p id='date'>Run date: <b>" + dates[dateId].day + "/" 
					+ dates[dateId].month + "/" + dates[dateId].year + "</b></p>"
				$('#selects').append(date)
			}
		}
		var selectedPerf = $("#perf").val();
		if (!selectedPerf || selectedPerf == ' ') {
			selectedPerf = 'speed';
			// Create select menu for performance
			var performanceSelect = "<div class='select'><select id='perf' onchange='perfChanged();'></select></div>"
			$(performanceSelect).replaceAll($('#performance .select'))
			fillPerformanceSelect();
		} else {
			drawPerformance(selectedPerf);
		}
	}
}
</script>

<script type="text/javascript">
/* Callback function for date selection */
function dateChanged() {
	var selectedPerf = $("#perf").val();
	if (!selectedPerf || selectedPerf == ' ') {
		selectedPerf = 'speed';
		var performanceSelect = "<div class='select'><select id='perf' onchange='perfChanged();'></select></div>"
		$(performanceSelect).replaceAll($('#performance .select'))
		fillPerformanceSelect();
	} else {
		drawPerformance(selectedPerf);
	}
}

function perfChanged() {
	var selectedPerf = $("#perf").val();
	drawPerformance(selectedPerf);
}

/* Populate the race select menu with the available races for current runner
 *
 * Params :
 *  - races : dictionary with string races as keys
 * Returns :
 *  - sortedRaces : array of dictionaries (see below in for loop)
 */ 
function fillRaceSelect(races) {
	var sortedRaces = []
	for (r in races) {
		sortedRaces.push({
			'racekey': r,
		})
	}

	$('#race').empty()
	allRaces = "<option value='all'>All races</option>"
	$('#race').append(allRaces)
	sortedRaces.forEach(function(r) {
		option = '<option value="'+ r.racekey +'">'+r.racekey+'</option>'
		$('#race').append(option)
	})
	drawFullMap()
	return sortedRaces
}

/* Populate the date select menu with the available dates for current race, current runner
 *
 * Params :
 *  - dates : dictionary with string dates as keys and attributes 'day',
 *      'month', 'year'
 * Returns :
 *  - sortedDates : array of dictionaries (see below in for loop)
 */ 
function fillDateSelect(dates) {
	$('#date').empty()
	if (dates != 'all') {
		var sortedDates = []
		for (var d in dates) {
			sortedDates.push({
				'datekey': d,
				'day': dates[d].day,
				'month': dates[d].month,
				'year': dates[d].year
			})
		}
		sortedDates = sortedDates.sort((a, b) => b.year - a.year);
		allYears = "<option value='all'>All years</option>";
		$('#date').append(allYears);
		sortedDates.forEach(function(d) {
			option = "<option value='"+ d.datekey +"'>"+
			d.day + '/' + d.month + '/'+ d.year +"</option>";
		$('#date').append(option);
		})
		return sortedDates;
	}
}

function fillPerformanceSelect() {
	$('#perf').append("<option value='speed'> Speed </option>")
	$('#perf').append("<option value='pace'> Pace </option>")
	$('#perf').append("<option value='rank'> Ranking </option>")
	$('#perf').append("<option value='distance'> Distance </option>")
	drawPerformance('speed');
}


// ----------------- PERFORMANCE GRAPHS ---------------------- //

/* --- Draws performance chart, given a performance key --- */
function drawPerformance(keyPerf) {
	// get the names of all races of currentRunner
	var raceKeys = Object.keys(allRacesObject);
	
	// get the selected race, or the first one if not specified (not 
	// specified = currentRunner has only participated to one race)
	var selectedRace = $('#race').val();
	if (!selectedRace || selectedRace == ' ') {
		raceKeys = [raceKeys[0]];
	} else if (selectedRace != 'all') {
		raceKeys = [selectedRace];
	}
		
	createPerfChart(raceKeys, keyPerf);
}

/* --- Creates the performance chart from scratch --- */
function createPerfChart(raceKeys, keyPerf) {
	var chartPerf = [];
	for (var l=0; l<raceKeys.length; l++){
		var allDates = Object.keys(currentRunner.races[raceKeys[l]].date);
		var currentRace = allRacesObject[raceKeys[l]];
		chartPerf.push(getAllPerformances(keyPerf, allDates, currentRace));
	}
	chartPerf = [].concat.apply([], chartPerf);
	var units = getPerfUnits(keyPerf);
		
	if (chartPerf.length > 1) { // Draw chart and write mean statistics
		var chart = c3.generate({
			bindto: '#performance .chart',
			data: {
				columns: [
					[keyPerf].concat(chartPerf)
				]
			}
		});
		
		// Write mean performance
		var sumPerf = chartPerf.reduce(function(a, b) { return a+b; });
		var avgPerf = sumPerf/chartPerf.length;
		var meanPerfStr = "";
		var maxPerfStr = "";
		var minPerfStr = "";
		if (keyPerf != 'rank') {
			var maxPerf = Math.max.apply(null, chartPerf);
			var minPerf = Math.min.apply(null, chartPerf); 
			if (keyPerf != 'distance') {
				maxPerf = maxPerf.toFixed(2);
				minPerf = minPerf.toFixed(2);
			}
			meanPerfStr = "<u>Mean " + keyPerf + "</u>: " + avgPerf.toFixed(2) + " " + units + "<br>";
			maxPerfStr = "<u>Maximal " + keyPerf + "</u>: " + maxPerf + " " + units + "<br>";
			minPerfStr = "<u>Minimal " + keyPerf + "</u>: " + minPerf + " " + units;
		} else { // case 'rank'
			var maxId = chartPerf.indexOf(Math.min.apply(null, chartPerf));
			var minId = chartPerf.indexOf(Math.min.apply(null, chartPerf));
			var maxPerf = perf[maxId][0];
			var minPerf = perf[minId][0];
			meanPerfStr = "This runner is <u>in average</u> amongst the first " + avgPerf 
				+ "% of the runners.<br>";
			maxPerfStr = "<u>Worst " + keyPerf + "</u>: " + maxPerf + " out of " + perf[maxId][1] + " runners.<br>";
			minPerfStr = "<u>Best " + keyPerf + "</u>: " + minPerf + " out of " + perf[minId][1] + " runners.";
		}
		
		var description = "<div class='text'><p>" + meanPerfStr + maxPerfStr + minPerfStr + "</p></div>";
		$(description).replaceAll('#performance .text')
			
	} else { // Only write the performance
		$("<div class='chart'></div>").replaceAll('#performance .chart');
		if ($("#perf")){
			$('#perf').remove(); 
		}
		
		perf = [];
		var selectedDate = $('#date').val();
		if (!selectedDate || selectedDate == " ") {
			selectedDate = allDates[0];
		}
		
		var keyCat = Object.keys(currentRunner.races[raceKeys[0]].date[selectedDate].categories)[0];
		perf.push(getPerformance(currentRace, selectedDate, 'distance', keyCat));
		perf.push(getPerformance(currentRace, selectedDate, 'pace', keyCat));
		perf.push(getPerformance(currentRace, selectedDate, 'rank', keyCat));
		perf.push(getPerformance(currentRace, selectedDate, 'speed', keyCat));
		
		var perfSpeed = "<u>Distance</u>: " + perf[0] + " km<br>";
		var perfPace = "<u>Pace</u>: " + perf[1].toFixed(2) + " min/km<br>";
		var perfRank = "<u>Rank</u>: " + perf[2][0] + " out of " + perf[2][1] + " runners.<br>";
		var perfDistance = "<u>Speed</u>: " + perf[3].toFixed(2) + " km/h";
		var description = "<div class='text'><p>" + perfSpeed + perfPace + perfRank + perfDistance + "</p></div>";
		$(description).replaceAll('#performance .text')
	}
}

function getAllPerformances(keyPerf, allDates, currentRace) {
	var perf = []
	
	var selectedDate = $('#date').val();
	if (!selectedDate || selectedDate == " ") {
		if (allDates.length > 1) {
			selectedDate = 'all';
		} else {
			selectedDate = allDates[0];
		}
	}
	
	var runnerDates = currentRunner.races[currentRace.name].date;
		
	// If all the dates are selected, get the performance of the 
	// runner during all those dates, otherwise get the performance 
	// of the runner only on the specified date	
	if (selectedDate == 'all') {
		for (var j=0; j<allDates.length; j++) {
			var allCategories = Object.keys(runnerDates[allDates[j]].categories);
			for (var k=0; k<allCategories.length; k++) {
				perf.push(getPerformance(currentRace, allDates[j], keyPerf, allCategories[k]));
			}
		}
	} else {
		var allCategories = Object.keys(runnerDates[selectedDate].categories);
		for (var k=0; k<allCategories.length; k++) {
			perf.push(getPerformance(currentRace, selectedDate, keyPerf, allCategories[k]));
		}
	}
	
	var chartPerf = perf;
	if (keyPerf == 'rank') {
		for (var j=0; j<perf.length; ++j) {  // take every second element
			chartPerf.push(perf[j][0]/perf[j][1]*100);
		}
	}
	
	return chartPerf;
}

function getPerfUnits(keyPerf) {
	var units = '';
	switch (keyPerf) {
		case 'distance':
			units = 'km';
			break;
		case 'pace': 
			units = 'min/km';
			break;
		case 'rank': 
			break;
		default: // 'speed'
			units = 'km/h';
			break;
	}
	return units;
}

/* --- Get the performance of a runner at a specified date, for a specified category --- */
// Args: date (Object file), keyPerf (string)
function getPerformance(currentRace, keyDate, keyPerf, keyCat) {
	var perf = null;
	var runnerDate = currentRunner.races[currentRace.name].date[keyDate];
	var interest = runnerDate.categories[keyCat];
	
	switch (keyPerf) {
		case 'distance': // units: km
			perf = interest.distance;
			break;
		case 'pace': // units: min/km
			perf = interest.time/(interest.distance*60); 
			break;
		case 'rank': // perf[2*n] = rank, perf[2*n+1] = total 
					 //number of runners in this race-date-category
			perf = [];
			perf.push(interest.rank);
			perf.push(currentRace.dates[keyDate].categories[keyCat].count);
			break;
		default: //'speed', units: km/h
			perf = interest.distance/interest.time*3600;
			break;
	}
	return perf;
}

// ---------------------------------------------------------------------

function selectOnlyThis(elem,id) {
	for (var i = 1;i <= 4; i++)
    {
        document.getElementById("perfCheck" + i).checked = false;
    }
    elem.checked = true;
}

function loadAndDisplay(encodedName) {
	allRacesObject = {};
	
	// Load JSON data
	$.getJSON("../runnerdata/" + encodedName + ".json", function(data) {
		console.log(data)
		// Set 'global' var to selected race
		currentRunner = data
		
		var racesLeft = Object.keys(currentRunner.races);
		loadRaceJSONAndDisplay(racesLeft);
	})
}

function loadRaceJSONAndDisplay(racesLeft) {
	var lastRace = racesLeft[racesLeft.length-1];
	var encodedName = encodeName(lastRace);
	$.getJSON("../racedata/" + encodedName + ".json", function(data) {
		if (!allRacesObject[lastRace]) {
			allRacesObject[lastRace] = [];
		}
		allRacesObject[lastRace] = data;
		racesLeft.pop();
		if (racesLeft.length == 0) {
			display();
		} else {
			loadRaceJSONAndDisplay(racesLeft);
		}
	}); 
}

function display() {
	console.log(allRacesObject)
	// Empty HTML
	$('#outputbox').empty()
	
	// Title + personal information
	var today = new Date();
	var year = today.getFullYear();
	var sex = 'homme';
	var pronom = "He";
	if (currentRunner.sex == 'F') {
		sex = 'femme';
		pronom = 'She';
	}
	var title = "<h2>"+ currentRunner.name +" <small>"
		+ (year - currentRunner.birth) +" ans, "+ sex 
		+".</small></h2>";
	$('#outputbox').append(title);
						
	$('#outputbox').append("<div id='globaldesc'></div>")
	$('#globaldesc').append("<div id='map'></div>")
	
	// Create select menu for races, if > 1
	if (Object.keys(currentRunner.races).length > 1) {
		
		$('#globaldesc').append("<div class='text'></div>")
		var raceNoSelect = 
			"<p>This runner has participated to <b>" + Object.keys(currentRunner.races).length
			+ " competitions</b>. <br>Click on them on the map or choose them below for more details.</p>";
		$('#globaldesc .text').append(raceNoSelect);
		
		$('#outputbox').append("<div id='selects'></div>")
		// Race select menu
		var raceSelect = "<select id='race' onchange='raceChanged();'></select>"
		$('#selects').append(raceSelect)
		fillRaceSelect(currentRunner.races)
		$('#selects').append("<div class='text'></div>")
		
		// Display performance + perf select menu
		$('#outputbox').append("<div id='performance'></div>")
		$('#performance').append("<h3> Performances:</h3>")
		var performanceSelect = "<div class='select'><select id='perf' onchange='perfChanged();'></select></div>"
		$('#performance').append(performanceSelect)
		$('#performance').append("<div class='chart'></div>")
		$('#performance').append("<div class='text'></div>")
		fillPerformanceSelect();

	} else {
		
		$('#globaldesc').append("<div class='text'></div>")
		var keyRace = Object.keys(currentRunner.races)[0];
		drawFullMap();
		
		var mLink = 'https://hopsuisse.github.io/races?date='+encodeName(keyRace);

		// Create select menu for dates, if > 1
		var selectedRace = Object.keys(currentRunner.races)[0];
		
		if (Object.keys(currentRunner.races[selectedRace].date).length > 1) {

			var nbParticipation = Object.keys(currentRunner.races[selectedRace].date).length;
			var raceNoSelect = 
				"<p>This runner has participated to only one competition: <b>" 
				+ keyRace + "</b>.<br> " + pronom + " has participated to it <b>"
				+ nbParticipation + " times</b>.</p>";
			$('#globaldesc .text').append(raceNoSelect);
							
			$('#outputbox').append("<div id='selects'></div>")
			$('#selects').append("<div class='text'></div>")
			var statRace = 
				"<p id='statRace'>For more general statistics about this race, click <a href=" 
				+ mLink + ">here</a>.</p>"
			$('#selects .text').append(statRace);
			
			// Date menu select
			var chooseDate = "<p id='chooseDate'>Or choose a particular date, if desired: "
				+ "<select id='date' onchange='dateChanged();'></select></p>"
			$('#selects').append(chooseDate)
			fillDateSelect(currentRunner.races[selectedRace].date)
			
			$('#outputbox').append("<div id='performance'></div>")
			$('#performance').append("<h3> Performances:</h3>")
			var performanceSelect = "<div class='select'><select id='perf' onchange='perfChanged();'></select></div>"
			$('#performance').append(performanceSelect)
			$('#performance').append("<div class='chart'></div>")
			$('#performance').append("<div class='text'></div>")
			fillPerformanceSelect();
			
		} else {

			var mDate = currentRunner.races[selectedRace].date;
			var dateId = Object.keys(mDate)[0];
			var raceNoSelect = 
				"<p>This runner has participated to only one competition: <b>" 
				+ Object.keys(currentRunner.races)[0] + "</b>. <br>Run date: <b>" 
				+ mDate[dateId].day + '/' + mDate[dateId].month + '/' 
				+ mDate[dateId].year + "</b>.</p>";
			$('#globaldesc .text').append(raceNoSelect)
			
			$('#outputbox').append("<div id='selects'></div>")
			$('#selects').append("<div class='text'></div>")
			var statRace = 
				"<p id='statRace'>For more general statistics about this race, click <a href=" 
				+ mLink + ">here</a>.</p>"
			$('#selects .text').append(statRace);
			
			$('#outputbox').append("<div id='performance'></div>")
			$('#performance').append("<h3> Performances:</h3>")
			$('#performance').append("<div class='chart'></div>")
			$('#performance').append("<div class='text'></div>")
			drawPerformance('speed')

		}
	}
}


// -------------------- MAIN CALLBACK FUNCTION --------------------- //
/* Callback function for race selection through search bar */
$(function(){
	$('#autocomplete').autocomplete({ 
		delay: 0,
		lookup: runners,
		onSelect: function (suggestion) {
			loadAndDisplay(suggestion.data);
		}
	});
}); 
</script>
