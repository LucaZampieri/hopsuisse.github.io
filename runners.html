---
layout: page
title: Runners
permalink: /runners/
---

<div id="searchfield">
  <h3>Search for a runner... <a id="randomlink" onmouseover="this.style.cursor = 'pointer'" onclick="displayRandom();">or
feel lucky !</a></h3>
  <form>
    <input type="text" name="runner" class="biginput" id="autocomplete" autocomplete="on"
    value="Type the name of a runner here..."
    onblur="if (this.value==''){this.value='Type the name of a runner here...';}" 
    onfocus="if (this.value!=''){this.value='';}">
  </form>
</div>

<div id="outputbox">
  <p id="outputcontent">Choose a runner and the results will be displayed here.</p>
</div>


<script type="text/javascript">
	
	var myMap = null;
	var runners = [
		{value:"Bosshart Catherine 1948",data:"bosshartcatherine1948"},
		{value:"Veillard Steeve 1982",data:"veillardsteeve1982"},
		{value:"Chanon Theo 2005",data:"chanontheo2005"},
		{value:"Schmidt Peter 1952",data:"schmidtpeter1952"},
		{value:"M\u00fcller Gu\u00e9nael 1998", data:"mullerguenael1998"}
	];
	var currentRunner = null;
</script>

<script type="text/javascript">
	// TODO: 	- complete list of runners -> transfer folder manually, 
	//			  do NOT change the _config.yml

function displayRandom() {
	var entry = Math.floor(Math.random() * runners.length);
	loadAndDisplay(runners[entry].data)
}

function encodeName(name) {
	function toLower(str) {
		return str.toLowerCase();
	}
	return name.replace(/[^0-9a-zA-Z+]/g, '').replace(/[A-Z]/g, toLower);
}

// --------------- MAPS ------------------ //
/* Draw a map of Switzerland with pointers where a runner has done a 
race, if coordinates are known. Only in the situation in which "All 
races" is selected. */
function drawFullMap() {
	if (myMap) {
		myMap.remove();
		myMap = null;
	}
	if (currentRunner) {
		$('#map').empty()
		$('#map').height(340).width(600)
		myMap = L.map('map').setView([46.4804,8.1336], 7);
		// Add actual layer
		var Stamen_Terrain_full = L.tileLayer('http://stamen-tiles-{s}.a.ssl.fastly.net/terrain/{z}/{x}/{y}.{ext}', {
			attribution: 'Map tiles by <a href="http://stamen.com">Stamen Design</a>, <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a> &mdash; Map data &copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',
			subdomains: 'abcd',
			minZoom: 0,
			maxZoom: 18,
			ext: 'png'
		}).addTo(myMap);
		addMarkers()
	}
}

function addMarkers() {
	for (let key of Object.keys(currentRunner.races)) {
		var currentRace = currentRunner.races[key]
		var mLat = currentRace.latitude;
		var mLong = currentRace.longitude;
		var nbParticipation = Object.keys(currentRace.date).length;
		if (mLat!=null && mLong!=null) {
			marker = L.marker([mLat, mLong]).addTo(myMap);
			console.log(encodeName(key))
			var popupMarker = "<b href='#' onclick='clickPopupFullMap(this)' " 
				+ "onmouseover='mouseOverPopupFullMap(this)' "
				+ "onmouseout='mouseOutPopupFullMap(this)'>" + key 
				+ "</b><br>"+ nbParticipation +" participation";
			if (nbParticipation > 1) 
				popupMarker += "s.";
			else
				popupMarker += ".";
			var mLink = 'https://hopsuisse.github.io/races?date='+encodeName(key);
			popupMarker += "<br><a href=" + mLink + ">Race general details</a>";
			marker.bindPopup(popupMarker)
		}
	}
}

/* Functions called when an event is launched on a popup of the fullMap */
function clickPopupFullMap(elem) {
	key = elem.innerHTML
	$('#race').val(key);
	raceChanged();
}
function mouseOverPopupFullMap(elem) {
	elem.style.textDecoration = 'underline';
	elem.style.cursor = 'pointer';
}
function mouseOutPopupFullMap(elem) {
	elem.style.textDecoration = 'none';
}

/* Draw a map centered on the race location if coordinates are known */
function drawMap() {
	if (myMap)
		myMap.remove();
	if (currentRunner) {
		var selectedRace = $("#race").val();
		if (!selectedRace || selectedRace == ' ') {
			selectedRace = Object.keys(currentRunner.races)[0];
		}
		
		if (selectedRace != 'all') {
			var specificRace = currentRunner.races[selectedRace];
			// Get latitude and longitude
			var latitude = specificRace.latitude
			var longitude = specificRace.longitude
			if (latitude!=null && longitude!=null) {
				$('#map').empty()
				$('#map').height(400).width(500)
				myMap = L.map('map').setView([latitude,longitude], 14);
				// Add actual layer
				var Stamen_Terrain = L.tileLayer('http://stamen-tiles-{s}.a.ssl.fastly.net/terrain/{z}/{x}/{y}.{ext}', {
					attribution: 'Map tiles by <a href="http://stamen.com">Stamen Design</a>, <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a> &mdash; Map data &copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',
					subdomains: 'abcd',
					minZoom: 0,
					maxZoom: 18,
					ext: 'png'
				}).addTo(myMap);
				addMarkers();
			} else {
				$('#map').empty()
				$('#map').width(0).height(0)
				//$('#globaldesc .text').width('100%')
			} 
		} else {
			$('#map').height(0).width(0);
			myMap = null;
		}
	}
}

// --------------- RACE AND DATE SELECTION -------------------- //
/* Callback function for race selection */
function raceChanged() {
	console.log(currentRunner)
	// Get selected racekey
	var selectedRace = $("#race").val();
	if (!selectedRace || selectedRace == ' ') {
		selectedRace = Object.keys(currentRunner.races)[0];
	}

	// Update dates select
	if (currentRunner) {
		if ($("#chooseDate")){
			$("#date").remove();
			$('#chooseDate').remove(); 
		}
		if ($("#statRace")){
			$("#statRace").remove();
		}
		if (selectedRace == 'all') {
			drawFullMap()
		} else {
			drawMap()
			var dates = currentRunner.races[selectedRace].date;
			var mLink = 'https://hopsuisse.github.io/races?date='+encodeName(selectedRace);
			var statRace = 
				"<p id='statRace'>For more general statistics about this race, click <a href=" 
				+ mLink + ">here</a>.</p>"
			$('#selects .text').append(statRace);
			
			if (Object.keys(dates).length > 1) {
				// Create select menu for dates
				var chooseDate = "<p id='chooseDate'>Or choose a particular date, if desired: "
					+ "<select id='date' onchange='dateChanged();'></select></p>"
				$('#selects').append(chooseDate)
				fillDateSelect(dates)
			} else {
				var dateId = Object.keys(dates)[0];
				var date = "<p id='date'>Run date: <b>" + dates[dateId].day + "/" 
					+ dates[dateId].month + "/" + dates[dateId].year + "</b></p>"
				$('#selects').append(date)
			}
		}
		var selectedPerf = $("#perf").val();
		if (!selectedPerf || selectedPerf == ' ') {
			selectedPerf = 'speed';
			// Create select menu for performance
			var performanceSelect = "<div class='select'><select id='perf' onchange='perfChanged();'></select></div>"
			$(performanceSelect).replaceAll($('#performance .select'))
			fillPerformanceSelect();
		} else {
			drawPerformance(selectedPerf);
		}
	}
}
</script>

<script type="text/javascript">
/* Callback function for date selection */
function dateChanged() {
	var selectedPerf = $("#perf").val();
	if (!selectedPerf || selectedPerf == ' ') {
		selectedPerf = 'speed';
		var performanceSelect = "<div class='select'><select id='perf' onchange='perfChanged();'></select></div>"
		$(performanceSelect).replaceAll($('#performance .select'))
		fillPerformanceSelect();
	} else {
		drawPerformance(selectedPerf);
	}
}

function perfChanged() {
	var selectedPerf = $("#perf").val();
	drawPerformance(selectedPerf);
}

/* Populate the race select menu with the available races for current runner
 *
 * Params :
 *  - races : dictionary with string races as keys
 * Returns :
 *  - sortedRaces : array of dictionaries (see below in for loop)
 */ 
function fillRaceSelect(races) {
	var sortedRaces = []
	for (r in races) {
		sortedRaces.push({
			'racekey': r,
		})
	}

	$('#race').empty()
	allRaces = "<option value='all'>All races</option>"
	$('#race').append(allRaces)
	sortedRaces.forEach(function(r) {
		option = '<option value="'+ r.racekey +'">'+r.racekey+'</option>'
		$('#race').append(option)
	})
	drawFullMap()
	return sortedRaces
}

/* Populate the date select menu with the available dates for current race, current runner
 *
 * Params :
 *  - dates : dictionary with string dates as keys and attributes 'day',
 *      'month', 'year'
 * Returns :
 *  - sortedDates : array of dictionaries (see below in for loop)
 */ 
function fillDateSelect(dates) {
	$('#date').empty()
	if (dates != 'all') {
		var sortedDates = []
		for (var d in dates) {
			sortedDates.push({
				'datekey': d,
				'day': dates[d].day,
				'month': dates[d].month,
				'year': dates[d].year
			})
		}
		sortedDates = sortedDates.sort((a, b) => b.year - a.year);
		allYears = "<option value='all'>All years</option>";
		$('#date').append(allYears);
		sortedDates.forEach(function(d) {
			option = "<option value='"+ d.datekey +"'>"+
			d.day + '/' + d.month + '/'+ d.year +"</option>";
		$('#date').append(option);
		})
		return sortedDates;
	}
}

function fillPerformanceSelect() {
	$('#perf').append("<option value='speed'> Speed </option>")
	$('#perf').append("<option value='pace'> Pace </option>")
	$('#perf').append("<option value='rank'> Ranking </option>")
	$('#perf').append("<option value='distance'> Distance </option>")
	drawPerformance('speed');
}

// ----------------- PERFORMANCE GRAPHS ---------------------- //
function getRunnerInfos() {
	var speed = [];
	var pace = [];
	var rank = [];
	var distance = [];
	var totRunners = [];
	var normalizedRank = [];
	var selectedRace = $('#race').val();
	if (!selectedRace || selectedRace == ' ') {
		selectedRace = Object.keys(currentRunner.races)[0];
	}

	if (selectedRace == 'all') {
		for (var keyRace in currentRunner.races) {
			for (var keyDate in currentRunner.races[keyRace].date) {
				for (var keyCat in currentRunner.races[keyRace].date[keyDate].categories) {
					var interest = currentRunner.races[keyRace].date[keyDate].categories[keyCat];
					var tot = getTotalNumberOfRunners(keyRace, keyDate, keyCat);
					totRunners.push(tot)
					normalizedRank.push(interest.rank/tot*100)
					speed.push(interest.distance/interest.time*3600)
					pace.push(interest.time/(interest.distance*60))
					rank.push(interest.rank)
					distance.push(interest.distance)
				}
			}
		}
	} else {
		var selectedDate = $('#date').val();
		if (!selectedDate || selectedDate == " ") {
			selectedDate = 'all';
		}
		if (selectedDate == 'all') {
			for (var keyDate in currentRunner.races[selectedRace].date) {
				for (var keyCat in currentRunner.races[selectedRace].date[keyDate].categories) {
					var interest = currentRunner.races[selectedRace].date[keyDate].categories[keyCat];
					var tot = getTotalNumberOfRunners(selectedRace, keyDate, keyCat);
					totRunners.push(tot)
					normalizedRank.push(interest.rank/tot*100)
					speed.push(interest.distance/interest.time*3600)
					pace.push(interest.time/(interest.distance*60))
					rank.push(interest.rank)
					distance.push(interest.distance)
				}
			}
		} else {
			for (var keyCat in currentRunner.races[selectedRace].date[selectedDate].categories) {
					var interest = currentRunner.races[selectedRace].date[selectedDate].categories[keyCat];
					var tot = getTotalNumberOfRunners(selectedRace, selectedDate, keyCat);
					totRunners.push(tot)
					normalizedRank.push(interest.rank/tot*100)
					speed.push(interest.distance/interest.time*3600)
					pace.push(interest.time/(interest.distance*60))
					rank.push(interest.rank)
					distance.push(interest.distance)
				}
		}
	}
	return [distance, pace, rank, speed, totRunners, normalizedRank];
}

function getTotalNumberOfRunners(keyRace, raceDate, raceDistance) {
	var count = getGenderCount(keyRace, raceDate, raceDistance);
	var totCount = count['men'] + count['women'];
	return totCount;
}

// TODO delete this function once coordinated with Max:
function getGenderCount(keyRace, raceDate, raceDistance) {
	return {'men':1000, 'women':1000};
}

function drawPerformance(keyPerf) {
	var infos = getRunnerInfos();

	if (infos[0].length > 1) {
		
		var perfId = 0;
		var units = "";
		switch (keyPerf) {
			case 'distance':
				perfId = 0;
				units = 'km';
				break;
			case 'pace':
				perfId = 1;
				units = 'min/km';
				break;
			case 'rank':
				perfId = 5;
				break;
			default: //'speed'
				perfId = 3;
				units = 'km/h';
				break;
		}
		var chart = c3.generate({
			bindto: '#performance .chart',
			data: {
				columns: [
					[keyPerf].concat(infos[perfId])
				]
			}
		});
		
		var sumPerf = infos[perfId].reduce(function(a, b) { return a + b; });
		var avgPerf = sumPerf / infos[perfId].length;
		var meanPerfStr = "";
		var maxPerfStr = "";
		var minPerfStr = "";
		if (keyPerf != 'rank') {
			var maxPerf = infos[perfId].reduce(function(a, b) {
				if (a>b) return a;
				else return b;
			});
			var minPerf = infos[perfId].reduce(function(a, b) {
				if (a>b) return b;
				else return a;
			});
			meanPerfStr = "<u>Mean " + keyPerf + "</u>: " + avgPerf + " " + units + "<br>";
			maxPerfStr = "<u>Maximal " + keyPerf + "</u>: " + maxPerf + " " + units + "<br>";
			minPerfStr = "<u>Minimal " + keyPerf + "</u>: " + minPerf + " " + units;
		} else { //Case rank
			var totRunners = infos[4];
			var rank = infos[2];
			var maxId = infos[perfId].indexOf(Math.min.apply(null, infos[perfId]));
			var minId = infos[perfId].indexOf(Math.max.apply(null, infos[perfId]));
			var maxPerf = rank[maxId];
			var minPerf = rank[minId];
			meanPerfStr = "This runner is <u>in average</u> amongst the first " + avgPerf 
				+ "% of the runners.<br>";
			maxPerfStr = "<u>Worst " + keyPerf + "</u>: " + maxPerf + " out of " + totRunners[maxId] + " runners.<br>";
			minPerfStr = "<u>Best " + keyPerf + "</u>: " + minPerf + " out of " + totRunners[minId] + " runners.";
		}
		var description = "<div class='text'><p>" + meanPerfStr + maxPerfStr + minPerfStr + "</p></div>";
		$(description).replaceAll('#performance .text')

	} else {

		$("<div class='chart'></div>").replaceAll('#performance .chart');
		if ($("#perf")){
			$('#perf').remove(); 
		}
		var perfSpeed = "<u>Speed</u>: " + infos[3][0] + " km/h<br>";
		var perfPace = "<u>Pace</u>: " + infos[1][0] + " min/km<br>";
		var perfRank = "<u>Rank</u>: " + infos[2][0] + " out of " + infos[4][0] + " runners.<br>";
		var perfDistance = "<u>Distance</u>: " + infos[0][0] + " km";
		var description = "<div class='text'><p>" + perfSpeed + perfPace + perfRank + perfDistance + "</p></div>";
		$(description).replaceAll('#performance .text')

	}
}

function selectOnlyThis(elem,id) {
	for (var i = 1;i <= 4; i++)
    {
        document.getElementById("perfCheck" + i).checked = false;
    }
    elem.checked = true;
}

function loadAndDisplay(encodedName) {
	// Load JSON data
	$.getJSON("../runnerdata/" + encodedName + ".json", function(data) {
		console.log(data)

		// Set 'global' var to selected race
		currentRunner = data

		// Empty HTML
		$('#outputbox').empty()
		
		// Title + personal information
		var today = new Date();
		var year = today.getFullYear();
		var sex = 'homme';
		var pronom = "He";
		if (currentRunner.sex == 'F') {
			sex = 'femme';
			pronom = 'She';
		}
		var title = "<h2>"+ currentRunner.name +" <small>"
			+ (year - currentRunner.birth) +" ans, "+ sex 
			+".</small></h2>";
		$('#outputbox').append(title);
							
		$('#outputbox').append("<div id='globaldesc'></div>")
		$('#globaldesc').append("<div id='map'></div>")
		
		// Create select menu for races, if > 1
		if (Object.keys(data.races).length > 1) {
			
			$('#globaldesc').append("<div class='text'></div>")
			var raceNoSelect = 
				"<p>This runner has participated to <b>" + Object.keys(data.races).length
				+ " competitions</b>. <br>Click on them on the map or choose them below for more details.</p>";
			$('#globaldesc .text').append(raceNoSelect);
			
			$('#outputbox').append("<div id='selects'></div>")
			// Race select menu
			var raceSelect = "<select id='race' onchange='raceChanged();'></select>"
			$('#selects').append(raceSelect)
			fillRaceSelect(data.races)
			$('#selects').append("<div class='text'></div>")
			
			// Display performance + perf select menu
			$('#outputbox').append("<div id='performance'></div>")
			$('#performance').append("<h3> Performances:</h3>")
			var performanceSelect = "<div class='select'><select id='perf' onchange='perfChanged();'></select></div>"
			$('#performance').append(performanceSelect)
			$('#performance').append("<div class='chart'></div>")
			$('#performance').append("<div class='text'></div>")
			fillPerformanceSelect();

		} else {
			
			$('#globaldesc').append("<div class='text'></div>")
			var keyRace = Object.keys(data.races)[0];
			drawFullMap();
			
			var mLink = 'https://hopsuisse.github.io/races?date='+encodeName(keyRace);

			// Create select menu for dates, if > 1
			var selectedRace = Object.keys(data.races)[0];
			
			if (Object.keys(data.races[selectedRace].date).length > 1) {

				var nbParticipation = Object.keys(data.races[selectedRace].date).length;
				var raceNoSelect = 
					"<p>This runner has participated to only one competition: <b>" 
					+ keyRace + "</b>.<br> " + pronom + " has participated to it <b>"
					+ nbParticipation + " times</b>.</p>";
				$('#globaldesc .text').append(raceNoSelect);
								
				$('#outputbox').append("<div id='selects'></div>")
				$('#selects').append("<div class='text'></div>")
				var statRace = 
					"<p id='statRace'>For more general statistics about this race, click <a href=" 
					+ mLink + ">here</a>.</p>"
				$('#selects .text').append(statRace);
				
				// Date menu select
				var chooseDate = "<p id='chooseDate'>Or choose a particular date, if desired: "
					+ "<select id='date' onchange='dateChanged();'></select></p>"
				$('#selects').append(chooseDate)
				fillDateSelect(currentRunner.races[selectedRace].date)
				
				$('#outputbox').append("<div id='performance'></div>")
				$('#performance').append("<h3> Performances:</h3>")
				var performanceSelect = "<div class='select'><select id='perf' onchange='perfChanged();'></select></div>"
				$('#performance').append(performanceSelect)
				$('#performance').append("<div class='chart'></div>")
				$('#performance').append("<div class='text'></div>")
				fillPerformanceSelect();
				
			} else {

				var mDate = currentRunner.races[selectedRace].date;
				var dateId = Object.keys(mDate)[0];
				var raceNoSelect = 
					"<p>This runner has participated to only one competition: <b>" 
					+ Object.keys(data.races)[0] + "</b>. <br>Run date: <b>" 
					+ mDate[dateId].day + '/' + mDate[dateId].month + '/' 
					+ mDate[dateId].year + "</b>.</p>";
				$('#globaldesc .text').append(raceNoSelect)
				
				$('#outputbox').append("<div id='selects'></div>")
				$('#selects').append("<div class='text'></div>")
				var statRace = 
					"<p id='statRace'>For more general statistics about this race, click <a href=" 
					+ mLink + ">here</a>.</p>"
				$('#selects .text').append(statRace);
				
				$('#outputbox').append("<div id='performance'></div>")
				$('#performance').append("<h3> Performances:</h3>")
				$('#performance').append("<div class='chart'></div>")
				$('#performance').append("<div class='text'></div>")
				drawPerformance('speed')

			}
		}
		
	})
}

// -------------------- MAIN CALLBACK FUNCTION --------------------- //
/* Callback function for race selection through search bar */
$(function(){
	$('#autocomplete').autocomplete({ 
		delay: 0,
		lookup: runners,
		onSelect: function (suggestion) {
			loadAndDisplay(suggestion.data);
		}
	});
}); 
</script>
