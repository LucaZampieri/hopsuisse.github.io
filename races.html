---
layout: page
title: Races
permalink: /races/
---

<div id="searchfield">
  <h3>Search for a race :</h3>
  <form>
    <input type="text" name="race" class="biginput" id="autocomplete"
    value="Type a location or a name here..." 
    onblur="if (this.value==''){this.value='Type a location or a name here...';}"
    onfocus="if (this.value!=''){this.value='';}">
  </form>
</div>

<div id="map"></div>
<div id="outputbox">
  <p id="outputcontent">Choose a race and the results will display here.</p>
</div>


<script type="text/javascript">
  var myMap = null;
  var races = [
    {% for race in site.data.racesnames %}
    {value:"{{race[1]}}",data:"{{race[0]}}"},
    {% endfor %}
  ];
  var currentRace = null;
</script>
<script type="text/javascript">
/* Draw a map centered on the race location if coordinates are known */
function drawMap() {
  if (currentRace) {
    // Get latitude and longitude
    var latitude = currentRace.latitude
    var longitude = currentRace.longitude

    // Display map
    if (myMap == null) {
      // First search : create the map
      $("#map").height(250);
      if (latitude!=null && longitude!=null) {
        myMap = L.map('map').setView([latitude,longitude], 10);
      }
    } else {
      // Update the map
      if (latitude!=null && longitude!=null) {
        myMap.setView([latitude,longitude], 10);
      } else {
        $("#map").height(0);
        myMap = null;
      }
    }
    
    // Add actual layer
    var Stamen_Terrain = L.tileLayer('http://stamen-tiles-{s}.a.ssl.fastly.net/terrain/{z}/{x}/{y}.{ext}', {
      attribution: 'Map tiles by <a href="http://stamen.com">Stamen Design</a>, <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a> &mdash; Map data &copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',
      subdomains: 'abcd',
      minZoom: 0,
      maxZoom: 18,
      ext: 'png'
    }).addTo(myMap);
  }
}

/* Get all possible distances for all years of the current race */
function getDistancesAllYears() {
  var distances = []
  
  // For each date, fetch the available distances and 
  // add them to the array
  for (let key of Object.keys(currentRace.dates)) {
    var mDist = Object.keys(currentRace.dates[key].distances)
    distances = distances.concat(mDist)
  }

  // Remove duplicates
  distances = [...new Set(distances)]
  
  return distances
}

/* Callback function for date selection */
function dateChanged() {
  // Get selected datekey
  var selectedDate = $('#date').val();
  
  // Update distances select
  if (currentRace) {
    if (selectedDate == 'all') {
      fillDistanceSelect(getDistancesAllYears())
    } else {
      fillDistanceSelect(Object.keys(currentRace.dates[selectedDate].distances))
    }
  }
  
  // Update displayed info
  drawTimeHistogram()
  drawGenderChart()
}

/* Callback function for distance selection */
function distanceChanged() {
  // Update displayed info
  drawTimeHistogram()
  drawGenderChart()
}

/* Populate the date select menu with the available dates for current race
 *
 * Params :
 *  - dates : dictionary with string dates as keys and attributes 'day',
 *      'month', 'year'
 * Returns :
 *  - sortedDates : array of dictionaries (see below in for loop)
 */
function fillDateSelect(dates) {
  console.log('fillDateSelect')
  console.log(dates)
  var sortedDates = []
  for (d in dates) {
    sortedDates.push(
        {
          'datekey': d,
          'day': dates[d].day,
          'month': dates[d].month,
          'year': dates[d].year
        })
  }
  sortedDates = sortedDates.sort((a, b) => b.year - a.year)

  $('#date').empty()
  allYears = "<option value='all'>All years</option>"
  $('#date').append(allYears)

  sortedDates.forEach(function(d) {
    option = "<option value='"+ d.datekey +"'>"+
      d.day + '/' + d.month + '/'+ d.year +"</option>"
    $('#date').append(option)
  })
  
  return sortedDates
}

/* Populate the distance select menu with the available distances for current race
 *
 * Params :
 *  - distances : array of string distances
 * Returns :
 *  - sortedDistance : array of int distances
 */
function fillDistanceSelect(distances) {
  var sortedDistances = []
  distances.forEach(function(d) {
    sortedDistances.push(Number(d))
  })
  sortedDistances = sortedDistances.sort((a, b) => b - a)

  $('#distance').empty()
  sortedDistances.forEach(function(d) {
    option = "<option value ="+ d +">" + d + "km" + "</option>"
    $('#distance').append(option)
  })

  return sortedDistances
}

/* Get times for current race given date and distance
 *
 * Params :
 *  - raceDate : string date or 'all'
 *  - raceDistance : string distance
 * Returns :
 *  - times : dictionary with string dates as keys and int arrays as values
 */
function getTimes(raceDate, raceDistance) {
  var times = {}
  if (raceDate == 'all') {
    for (let key of Object.keys(currentRace.dates)) {
      var mDistData = currentRace.dates[key].distances[raceDistance]
      if (mDistData) {
        var mTimes = mDistData.times
        times[key] = mTimes
      }
    }
  } else {
    times[raceDate] = currentRace.dates[raceDate].distances[raceDistance].times
  }
  return times
}

/* Draw histogram for times for the current race, date & distance selection */
function drawTimeHistogram() {
  // Get selected date and distance
  var mDate = $('#date').val();
  var mDistance = $('#distance').val()

  // Get times for this choice
  var times = getTimes(mDate, mDistance)

  // Create bins and counts
  var numBins = 10
  allTimes = []
  for (let key of Object.keys(times)) {
    allTimes = allTimes.concat(times[key])
  }
  var bins = linspace(allTimes, numBins, true)
  var counts = []
  for (let key of Object.keys(times)) {
    var mCounts = valueCounts(times[key], bins, true)
    mCounts.unshift(key)
    counts.push(mCounts)
  }

  // Make bin ticks
  binTicks = makeBinTicks(bins)

  // Draw chart
  var chart = c3.generate({
    bindto: '#histchart',
    data: {
      columns: counts,
      type: 'bar',
    },
    axis: {
      x: {
        label: {text:'Time (seconds)',position:'outer-center'},
        type: 'category',
        categories: binTicks,
        tick: {
          format: function(i) { return binTicks[i].split(' - ')[0] }
        }
      },
      y: {
        label: 'Number of runners'
      }
    },
    tooltip: {
      grouped: false,
      format: {
        title: function(i) { return binTicks[i] + ' seconds' },
      }
    },
    transition: {
      duration: 0
    },
    onrendered: function() {
      // HOTFIX for ticks position...
      $('#histchart .c3-axis-x .tick text').attr('transform', 'translate(-35,0)')
    }
  })
}

function getGenderCounts(raceDate, raceDistance) {
  var countMen = 0, countWomen = 0
  if (raceDate == 'all') {
    for (let key of Object.keys(currentRace.dates)) {
      var mDistData = currentRace.dates[key].distances[raceDistance]
      if (mDistData) {
        countMen += mDistData.count_men
        countWomen += mDistData.count_women
      }
    }
  } else {
    countMen = currentRace.dates[raceDate].distances[raceDistance].count_men
    countWomen = currentRace.dates[raceDate].distances[raceDistance].count_women
  }
  return {'men': countMen, 'women': countWomen}
}

/* Draw gender donut chart for current race, date & distance selection */
function drawGenderChart() {
  // Get selected date and distance
  var mDate = $('#date').val();
  var mDistance = $('#distance').val()

  // Get gender counts for this choice
  var counts = getGenderCounts(mDate, mDistance)
  var countMen = counts.men
  var countWomen = counts.women

  // Draw chart
  var chart = c3.generate({
    bindto: '#genderchart',
    data: {
      columns: [
        ['men', countMen],
        ['women', countWomen]
      ],
      type: 'donut'
    },
    donut: {
      title: "Gender proportions"
    }
  })
}

/* Callback function for race selection through search bar */
$(function(){
  $('#autocomplete').autocomplete({
    lookup: races,
    onSelect: function (suggestion) {
      // Load JSON data
      $.getJSON("/racedata/" + suggestion.data + ".json", function(data) {
        console.log(data)
        
        // Set 'global' var to selected race
        currentRace = data
 
        // Empty HTML
        $('#outputbox').empty()

        // Create select menu for dates
        var dateSelect = "<select id='date' onchange='dateChanged();'></select>"
        $('#outputbox').append(dateSelect)
        var sortedDates = fillDateSelect(data.dates)
        
        // Create select menu for distances
        var distanceSelect = "<select id='distance' onchange='distanceChanged();'></select>"
        $('#outputbox').append(distanceSelect)
        var sortedDistances = fillDistanceSelect(Object.keys(data.dates[sortedDates[0].datekey].distances))
        
        // Draw map
        drawMap()
        
        // Draw histogram for times
        var chartdiv = "<div id='histchart'></div>"
        $('#outputbox').append(chartdiv)
        drawTimeHistogram()
        
        // Draw gender donut chart
        var genderChart = "<div id='genderchart'></div>"
        $('#outputbox').append(genderChart)
        drawGenderChart()
      })
    }
  });
});
</script>

